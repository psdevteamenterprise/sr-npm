{"version":3,"names":["_errors","require","WixDataResultImpl","constructor","items","paging","fetch","context","origin","currentPage","_defineProperty2","default","collectionName","skipNumber","pageSize","totalCount","allowOffsetBackwards","total","undefined","limitNumber","len","length","hasNext","Math","ceil","Symbol","iterator","totalPages","next","validationError","messages","queryValidations","noNextPage","offset","nextCursor","prev","hasPrev","noPrevPage","max","prevCursor","_this$paging$cursors","cursors","_this$paging$cursors2","_this$paging$cursors3","toJSON","exports"],"sources":["../../../../src/api/impl/WixDataResultImpl.ts"],"sourcesContent":["import { PagingMetadataV2, ReferencedItemOptions } from '../../types'\nimport { messages, validationError } from '../../errors'\nimport { WixDataItem } from '../types'\nimport { WixDataResult } from '../WixDataResult'\n\nexport type PageFetcher<Item = WixDataItem> = (\n  cursorOrOffset: string | number,\n  returnTotalCount?: boolean\n) => Promise<[Item[], PagingMetadataV2]>\n\nexport class WixDataResultImpl<Item = WixDataItem>\n  implements WixDataResult<Item>\n{\n  readonly items: Item[]\n\n  readonly totalCount: number | undefined\n\n  readonly pageSize: number | undefined\n\n  readonly currentPage: number | undefined\n\n  readonly collectionName: string\n\n  private readonly skipNumber: number | undefined\n  private readonly allowOffsetBackwards: boolean\n\n  constructor(\n    items: Item[],\n    private readonly paging: PagingMetadataV2,\n    private readonly fetch: PageFetcher<Item>,\n    context: {\n      limitNumber?: number\n      skipNumber?: number\n      collectionName: string\n      referencedItemOptions?: ReferencedItemOptions[]\n    },\n    origin?: WixDataResultImpl<Item>,\n    currentPage?: number\n  ) {\n    this.items = items\n    this.currentPage = currentPage\n    this.collectionName = context.collectionName\n    this.skipNumber = context.skipNumber ?? origin?.skipNumber\n    if (origin) {\n      this.pageSize = origin.pageSize\n      this.totalCount = origin.totalCount\n      this.allowOffsetBackwards = (currentPage ?? 0) > 0\n    } else {\n      // first time query â€“ paging may have total size\n      this.totalCount = paging.total ?? undefined\n      this.allowOffsetBackwards = (context.skipNumber ?? 0) > 0\n      if (context.limitNumber !== undefined) {\n        this.pageSize = context.limitNumber\n      } else {\n        // try to eval pageSize from items size\n        const len = items.length\n        if (\n          len > 0 &&\n          ((context.skipNumber !== undefined &&\n            len + context.skipNumber <= (this.totalCount ?? 0)) ||\n            paging.hasNext)\n        ) {\n          this.pageSize = len\n        }\n      }\n      if (this.pageSize && items.length > 0) {\n        // current page is not 0 if offset used\n        this.currentPage = Math.ceil((context.skipNumber ?? 0) / this.pageSize)\n      }\n    }\n  }\n\n  get length(): number {\n    return this.items.length\n  }\n\n  /**\n   * Can be iterated as array of items\n   */\n  [Symbol.iterator]() {\n    return this.items[Symbol.iterator]()\n  }\n\n  get totalPages(): number | undefined {\n    if (this.totalCount === 0) {\n      return 0\n    }\n    const pageSize = this.pageSize\n    if (pageSize !== undefined && this.totalCount !== undefined) {\n      return Math.ceil(this.totalCount / pageSize)\n    }\n    if (\n      this.totalCount !== undefined &&\n      this.skipNumber !== undefined &&\n      this.length > 0 &&\n      this.length + this.skipNumber <= this.totalCount\n    ) {\n      return Math.ceil(this.totalCount / this.length)\n    }\n    return undefined\n  }\n\n  async next(): Promise<WixDataResult<Item>> {\n    if (!this.hasNext()) {\n      throw validationError(\n        messages.queryValidations.noNextPage(this.collectionName)\n      )\n    }\n    const offset = (this.skipNumber ?? 0) + (this.pageSize ?? 50)\n    const [items, paging] = await this.fetch(this.nextCursor ?? offset)\n    return new WixDataResultImpl(\n      items,\n      paging,\n      this.fetch,\n      {\n        skipNumber: this.nextCursor ? undefined : offset,\n        collectionName: this.collectionName,\n      },\n      this,\n      (this.currentPage ?? 0) + 1\n    )\n  }\n\n  async prev(): Promise<WixDataResult<Item>> {\n    if (!this.hasPrev()) {\n      throw validationError(\n        messages.queryValidations.noPrevPage(this.collectionName)\n      )\n    }\n    const offset = Math.max((this.skipNumber ?? 0) - (this.pageSize ?? 50), 0)\n    const [items, paging] = await this.fetch(this.prevCursor ?? offset)\n    return new WixDataResultImpl(\n      items,\n      paging,\n      this.fetch,\n      {\n        skipNumber: this.nextCursor ? undefined : offset,\n        collectionName: this.collectionName,\n      },\n      this,\n      Math.max((this.currentPage ?? 0) - 1, 0) // in case if paged by cursor but on page 0\n    )\n  }\n\n  get nextCursor(): string | undefined {\n    return this.paging.cursors?.next ?? undefined\n  }\n\n  get prevCursor(): string | undefined {\n    return this.paging.cursors?.prev ?? undefined\n  }\n\n  hasNext(): boolean {\n    return this.paging.hasNext ?? false\n  }\n\n  hasPrev(): boolean {\n    return (\n      (this.allowOffsetBackwards && (this.currentPage ?? 0) > 0) ||\n      typeof this.paging.cursors?.prev === 'string'\n    )\n  }\n\n  toJSON() {\n    return {\n      items: this.items,\n      totalCount: this.totalCount,\n      pageSize: this.pageSize,\n      currentPage: this.currentPage,\n      length: this.length,\n      totalPages: this.totalPages,\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]}