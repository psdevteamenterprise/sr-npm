{"version":3,"names":["_types","require","_QueryValidator","_QueryBase","WixDataSearchImpl","QueryBase","constructor","origin","_defineProperty2","default","projectedFields","limitNumber","skipNumber","included","ownInvalidArguments","invalidArguments","queryText","searchMode","isFuzzy","onRun","copy","params","filterBuilder","sort","expression","andMode","Mode","AND","orMode","OR","fuzzy","run","options","toSearchParams","filterTree","build","_error","collectionName","orderBy","fields","limit","queryValidator","arityIsOne","arguments","isPositiveNumber","isInteger","validateAndAggregate","skip","isNonNegativeNumber","include","args","length","last","undefined","expectedFieldNameCount","newIncludes","slice","map","fieldName","reduce","validator","value","_","__","nonEmptyString","operatorName","QueryValidator","exports"],"sources":["../../../../src/api/impl/WixDataSearchImpl.ts"],"sourcesContent":["import { PlatformizedFilterBuilder } from '../../filter'\nimport { ReferencedItemOptions, Mode } from '../../types'\nimport { Sort } from '../../sort/sortMixin'\nimport { WixDataResult } from '../WixDataResult'\nimport { WixDataReadOptions } from '../types'\nimport { QueryValidator } from '../QueryValidator'\nimport { QueryBase } from '../QueryBase'\nimport { WixDataSearch } from '../WixDataSearch'\n\ntype OnRun = (\n  params: SearchParams,\n  options?: WixDataReadOptions\n) => Promise<WixDataResult>\n\nexport type SearchParams = {\n  collectionName: string\n  invalidArguments: string[]\n  filterTree?: Record<string, any>\n  projectedFields: string[]\n  limitNumber?: number\n  skipNumber: number\n  included: ReferencedItemOptions[]\n  orderBy: { [field: string]: 'asc' | 'desc' }[]\n  queryText?: string\n  searchMode?: Mode\n  isFuzzy?: boolean\n}\n\nexport class WixDataSearchImpl\n  extends QueryBase<WixDataSearchImpl>\n  implements WixDataSearch\n{\n  readonly projectedFields: string[]\n\n  readonly limitNumber?: number\n\n  readonly skipNumber: number\n\n  readonly included: ReferencedItemOptions[]\n\n  private readonly queryText?: string\n  private readonly searchMode?: Mode\n  private readonly isFuzzy?: boolean\n\n  private readonly onRun: OnRun\n\n  private readonly ownInvalidArguments: string[]\n\n  constructor(origin: {\n    collectionName: string\n    filterBuilder?: PlatformizedFilterBuilder\n    invalidArguments?: string[]\n    projectedFields?: string[]\n    limitNumber?: number\n    skipNumber?: number\n    included?: ReferencedItemOptions[]\n    sort?: Sort\n    queryText?: string\n    searchMode?: Mode\n    isFuzzy?: boolean\n    onRun: OnRun\n  }) {\n    super(origin)\n    this.projectedFields = origin?.projectedFields ?? []\n    this.limitNumber = origin?.limitNumber\n    this.skipNumber = origin?.skipNumber ?? 0\n    this.included = origin?.included ?? []\n    this.ownInvalidArguments = origin.invalidArguments ?? []\n    this.queryText = origin.queryText\n    this.searchMode = origin.searchMode\n    this.isFuzzy = origin.isFuzzy\n    this.onRun = origin.onRun\n  }\n\n  protected override copy(params: {\n    filterBuilder?: PlatformizedFilterBuilder\n    projectedFields?: string[]\n    limitNumber?: number\n    skipNumber?: number\n    included?: ReferencedItemOptions[]\n    sort?: Sort\n    invalidArguments?: string[]\n    queryText?: string\n    searchMode?: Mode\n    isFuzzy?: boolean\n  }): WixDataSearchImpl {\n    return new WixDataSearchImpl({\n      ...this,\n      filterBuilder: params.filterBuilder ?? this.filterBuilder,\n      projectedFields: params.projectedFields ?? this.projectedFields,\n      limitNumber: params.limitNumber ?? this.limitNumber,\n      skipNumber: params.skipNumber ?? this.skipNumber,\n      included: params.included ?? this.included,\n      sort: params.sort ?? this.sort,\n      invalidArguments: params.invalidArguments ?? this.ownInvalidArguments,\n      queryText: params.queryText ?? this.queryText,\n      searchMode: params.searchMode ?? this.searchMode,\n      isFuzzy: params.isFuzzy ?? this.isFuzzy,\n      onRun: this.onRun,\n    })\n  }\n\n  expression(queryText: string): WixDataSearch {\n    return this.copy({ queryText })\n  }\n\n  andMode(): WixDataSearch {\n    return this.copy({ searchMode: Mode.AND })\n  }\n\n  orMode(): WixDataSearch {\n    return this.copy({ searchMode: Mode.OR })\n  }\n\n  fuzzy(): WixDataSearch {\n    return this.copy({ isFuzzy: true })\n  }\n\n  run(options?: WixDataReadOptions): Promise<WixDataResult> {\n    return this.onRun(this.toSearchParams(), options)\n  }\n\n  get invalidArguments(): string[] {\n    return [\n      ...this.ownInvalidArguments,\n      ...this.filterBuilder.invalidArguments,\n      ...this.sort.invalidArguments,\n    ]\n  }\n\n  private toSearchParams(): SearchParams {\n    let filterTree\n    try {\n      // optimized filter if no errors\n      filterTree = this.filterBuilder.build()\n    } catch (_error: unknown) {\n      filterTree = this.filterBuilder.filterTree\n    }\n    return {\n      collectionName: this.collectionName,\n      invalidArguments: this.invalidArguments,\n      projectedFields: this.projectedFields,\n      limitNumber: this.limitNumber,\n      skipNumber: this.skipNumber,\n      included: this.included,\n      filterTree,\n      orderBy: this.orderBy,\n      queryText: this.queryText,\n      searchMode: this.searchMode,\n      isFuzzy: this.isFuzzy,\n    }\n  }\n\n  fields(...fields: string[]): WixDataSearch {\n    return this.copy({\n      projectedFields: [...this.projectedFields, ...fields],\n    })\n  }\n\n  limit(limitNumber: number) {\n    const [invalidArguments] = this.queryValidator('.limit')\n      .arityIsOne(arguments)\n      .isPositiveNumber(limitNumber)\n      .isInteger(limitNumber)\n      .validateAndAggregate()\n    return this.copy({\n      invalidArguments,\n      limitNumber,\n    })\n  }\n\n  skip(skipNumber: number) {\n    const [invalidArguments] = this.queryValidator('.skip')\n      .arityIsOne(arguments)\n      .isNonNegativeNumber(skipNumber)\n      .isInteger(skipNumber)\n      .validateAndAggregate()\n    return this.copy({\n      invalidArguments,\n      skipNumber,\n    })\n  }\n\n  include(...fieldNames: string[]): WixDataSearch\n\n  include(fieldName: string, limit?: number): WixDataSearch\n\n  include(fieldName1: string, fieldName2: string, limit?: number): WixDataSearch\n\n  include(\n    fieldName1: string,\n    fieldName2: string,\n    fieldName3: string,\n    limit?: number\n  ): WixDataSearch\n\n  include(\n    fieldName1: string,\n    fieldName2: string,\n    fieldName3: string,\n    fieldName4: string,\n    limit?: number\n  ): WixDataSearch\n\n  include(\n    fieldName1: string,\n    fieldName2: string,\n    fieldName3: string,\n    fieldName4: string,\n    fieldName5: string,\n    limit?: number\n  ): WixDataSearch\n\n  include(...fieldNamesAndLimit: [...string[], number]): WixDataSearch\n\n  include(...args: unknown[]): WixDataSearch {\n    if (args.length === 0) {\n      return this\n    }\n\n    const last = args[args.length - 1]\n    const limit: number | undefined =\n      typeof last === 'number' ? last : undefined\n\n    const expectedFieldNameCount =\n      limit === undefined ? args.length : args.length - 1\n\n    const newIncludes = args\n      .slice(0, expectedFieldNameCount)\n      .map((fieldName) => ({\n        fieldName: fieldName as string,\n        limit,\n      }))\n\n    const [invalidArguments] = args\n      .slice(0, expectedFieldNameCount)\n      .reduce<QueryValidator>(\n        (validator: QueryValidator, value: unknown, _, __) =>\n          validator.nonEmptyString(value),\n        this.queryValidator('.include')\n      )\n      .validateAndAggregate()\n\n    return this.copy({\n      invalidArguments,\n      included: [...this.included, ...newIncludes],\n    })\n  }\n\n  private queryValidator(\n    operatorName: string,\n    invalidArguments = this.ownInvalidArguments\n  ) {\n    return new QueryValidator(operatorName, invalidArguments)\n  }\n}\n"],"mappings":"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","ignoreList":[]}