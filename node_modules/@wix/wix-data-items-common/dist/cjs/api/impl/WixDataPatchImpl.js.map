{"version":3,"names":["_errors","require","_utils","WixDataPatchBase","constructor","origin","_defineProperty2","default","ownInvalidArguments","invalidArguments","fieldModifications","collectionName","incrementField","fieldName","by","patchValidator","arityIsTwo","arguments","isNumber","validateAndAggregate","copy","addFieldModification","fieldPath","action","actionOptions","setField","value","appendToArray","removeFromArray","removeField","operatorName","PatchValidator","WixDataBulkPatchImpl","onRun","itemIds","params","run","options","exports","WixDataPatchImpl","itemId","AggregatingValidator","previousInvalidArguments","specifier","operand","addValidation","messages","queryValidations"],"sources":["../../../../src/api/impl/WixDataPatchImpl.ts"],"sourcesContent":["import { WixDataItem, WixDataBulkResult, WixDataPatchOptions } from '../types'\nimport { AggregatingValidator, messages } from '../../errors'\nimport { isNumber } from '../../utils'\nimport {\n  FieldModification,\n  WixDataBulkPatch,\n  WixDataPatch,\n} from '../WixDataPatch'\n\ninterface BulkPatchParams {\n  collectionName: string\n  itemIds: string[]\n  invalidArguments: string[]\n  fieldModifications: FieldModification[]\n}\n\ninterface PatchParams {\n  collectionName: string\n  itemId: string\n  invalidArguments: string[]\n  fieldModifications: FieldModification[]\n}\n\ntype OnRun = (\n  args: IArguments,\n  params: PatchParams,\n  options?: WixDataPatchOptions\n) => Promise<WixDataItem | null>\n\ntype OnBulkRun = (\n  args: IArguments,\n  params: BulkPatchParams,\n  options?: WixDataPatchOptions\n) => Promise<WixDataBulkResult>\n\nabstract class WixDataPatchBase<Self> {\n  protected readonly fieldModifications: FieldModification[]\n  protected readonly collectionName: string\n  protected readonly ownInvalidArguments: string[]\n\n  constructor(origin: {\n    collectionName: string\n    invalidArguments?: string[]\n    fieldModifications?: FieldModification[]\n  }) {\n    this.ownInvalidArguments = origin.invalidArguments ?? []\n    this.fieldModifications = origin.fieldModifications ?? []\n    this.collectionName = origin.collectionName\n  }\n\n  protected abstract copy(params: {\n    invalidArguments?: string[]\n    addFieldModification: FieldModification\n  }): Self\n\n  incrementField(fieldName: string, by: number): Self {\n    const [invalidArguments] = this.patchValidator('.incrementField')\n      .arityIsTwo(arguments)\n      .isNumber(fieldName, by)\n      .validateAndAggregate()\n\n    return this.copy({\n      invalidArguments,\n      addFieldModification: {\n        fieldPath: fieldName,\n        action: 'INCREMENT_FIELD',\n        actionOptions: by,\n      },\n    })\n  }\n\n  setField(fieldName: string, value: any): Self {\n    const [invalidArguments] = this.patchValidator('.setField')\n      .arityIsTwo(arguments)\n      .validateAndAggregate()\n\n    return this.copy({\n      invalidArguments,\n      addFieldModification: {\n        fieldPath: fieldName,\n        action: 'SET_FIELD',\n        actionOptions: value,\n      },\n    })\n  }\n\n  appendToArray(fieldName: string, value: any): Self {\n    const [invalidArguments] = this.patchValidator('.appendToArray')\n      .arityIsTwo(arguments)\n      .validateAndAggregate()\n\n    return this.copy({\n      invalidArguments,\n      addFieldModification: {\n        fieldPath: fieldName,\n        action: 'APPEND_TO_ARRAY',\n        actionOptions: value,\n      },\n    })\n  }\n\n  removeFromArray(fieldName: string, value: any): Self {\n    const [invalidArguments] = this.patchValidator('.removeFromArray')\n      .arityIsTwo(arguments)\n      .validateAndAggregate()\n\n    return this.copy({\n      invalidArguments,\n      addFieldModification: {\n        fieldPath: fieldName,\n        action: 'REMOVE_FROM_ARRAY',\n        actionOptions: value,\n      },\n    })\n  }\n\n  removeField(fieldName: string): Self {\n    const [invalidArguments] = this.patchValidator('.removeField')\n      .arityIsTwo(arguments)\n      .validateAndAggregate()\n\n    return this.copy({\n      invalidArguments,\n      addFieldModification: {\n        fieldPath: fieldName,\n        action: 'REMOVE_FIELD',\n      },\n    })\n  }\n\n  private patchValidator(operatorName: string) {\n    return new PatchValidator(operatorName, this.ownInvalidArguments)\n  }\n}\n\nexport class WixDataBulkPatchImpl\n  extends WixDataPatchBase<WixDataBulkPatchImpl>\n  implements WixDataBulkPatch\n{\n  private readonly onRun: OnBulkRun\n  readonly itemIds: string[]\n\n  constructor(origin: {\n    collectionName: string\n    itemIds: string[]\n    invalidArguments?: string[]\n    fieldModifications?: FieldModification[]\n    onRun: OnBulkRun\n  }) {\n    super(origin)\n    this.onRun = origin.onRun\n    this.itemIds = origin.itemIds\n  }\n\n  protected copy(params: {\n    invalidArguments?: string[]\n    addFieldModification: FieldModification\n  }): WixDataBulkPatchImpl {\n    return new WixDataBulkPatchImpl({\n      ...this,\n      invalidArguments: params.invalidArguments ?? this.ownInvalidArguments,\n      fieldModifications: [\n        ...this.fieldModifications,\n        ...[params.addFieldModification],\n      ],\n      onRun: this.onRun,\n    })\n  }\n\n  run(options?: WixDataPatchOptions): Promise<WixDataBulkResult> {\n    return this.onRun(\n      arguments,\n      {\n        collectionName: this.collectionName,\n        itemIds: this.itemIds,\n        invalidArguments: this.ownInvalidArguments,\n        fieldModifications: this.fieldModifications,\n      },\n      options\n    )\n  }\n}\n\nexport class WixDataPatchImpl\n  extends WixDataPatchBase<WixDataPatchImpl>\n  implements WixDataPatch\n{\n  private readonly onRun: OnRun\n  readonly itemId: string\n\n  constructor(origin: {\n    collectionName: string\n    itemId: string\n    invalidArguments?: string[]\n    fieldModifications?: FieldModification[]\n    onRun: OnRun\n  }) {\n    super(origin)\n    this.onRun = origin.onRun\n    this.itemId = origin.itemId\n  }\n\n  protected copy(params: {\n    invalidArguments?: string[]\n    addFieldModification: FieldModification\n  }): WixDataPatchImpl {\n    return new WixDataPatchImpl({\n      ...this,\n      invalidArguments: params.invalidArguments ?? this.ownInvalidArguments,\n      fieldModifications: [\n        ...this.fieldModifications,\n        ...[params.addFieldModification],\n      ],\n      onRun: this.onRun,\n    })\n  }\n\n  run(options?: WixDataPatchOptions): Promise<WixDataItem | null> {\n    return this.onRun(\n      arguments,\n      {\n        collectionName: this.collectionName,\n        itemId: this.itemId,\n        invalidArguments: this.ownInvalidArguments,\n        fieldModifications: this.fieldModifications,\n      },\n      options\n    )\n  }\n}\n\nclass PatchValidator extends AggregatingValidator {\n  constructor(public operatorName: string, previousInvalidArguments: string[]) {\n    super(previousInvalidArguments)\n    this.operatorName = operatorName\n  }\n\n  isNumber(specifier: string, operand: any) {\n    return this.addValidation(\n      () => isNumber(operand),\n      () =>\n        messages.queryValidations.isNumber(\n          this.operatorName,\n          specifier,\n          operand\n        )\n    )\n  }\n}\n"],"mappings":"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","ignoreList":[]}